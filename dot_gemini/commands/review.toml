prompt = """
Thorough code review. Scope determined by context.

$ARGUMENTS

---

## Scope Detection

Detect automatically (priority order):

1. User provided specific files/paths? → Review those only
2. On feature branch? `git branch --show-current` (not main/master) → diff vs main
3. On main, has upstream remote? (fork pattern) → diff vs upstream/main
4. On main, has version tags? (solo project) → diff vs last tag
5. On main, has unpushed commits? → diff vs origin/main
6. Has staged changes? → review staged
7. Has unstaged changes? → review unstaged
8. Nothing to review → inform user

---

## Review Focus Areas

Review all three areas. Report issues with confidence >= 80%.

### 1. Correctness

Logic and functional correctness.

- Logic errors, off-by-one, boundary conditions
- Null/undefined handling
- State consistency (partial failures)
- Race conditions (if concurrent)
- Edge cases: empty, max, negative, zero
- Control flow correctness
- Algorithm correctness

### 2. Safety

Security and error handling (defensive thinking).

- Input validation at boundaries
- Hardcoded secrets, credentials
- Injection: SQL, XSS, command, path traversal
- Auth/authz checks
- Sensitive data in logs
- Silent failures, empty catch blocks
- Error propagation (swallowed vs bubbled)
- Fallback behavior hiding problems
- Resource cleanup on error

### 3. Quality

Design, performance, and idioms.

- Fits existing patterns?
- Single responsibility
- Over-engineering (future problems?)
- Code smells: long functions (>40 lines), large files (>400 lines)
- Dead code, unused variables
- Naming: intention-revealing, proportional to scope
- No `_v2`, `_new` suffixes
- Unnecessary allocations (`String` vs `&str`, `Vec` vs `&[T]`)
- O(n^2) where O(n) possible
- Blocking I/O in async, N+1 queries
- Language idioms (Rust/Python/Go/TS)

---

## Language Idioms

**Rust**: `anyhow`/`thiserror`, no `unwrap()` in prod, borrowing over cloning
**Python**: Type hints, `pathlib`, context managers, comprehensions
**Go**: Error wrapping, `defer`, no naked returns
**TypeScript**: Strict nulls, `async`/`await`, no `as any` casts

---

## Output Format

```
[SEVERITY] file:line - Issue
  -> Suggested fix
```

**Severities:**
- **ERROR**: Must fix (bugs, security, silent failures)
- **WARN**: Should fix (smells, performance)
- **NIT**: Optional (style, minor)

Be thorough. No false positives. Only flag what you're confident about.

---

## Summary

```
## Review Summary

Scope: [X files, Y lines]
Issues: ERROR: X, WARN: X, NIT: X

## Critical (must fix)

[ERROR] file:line - Issue
  -> Fix

## Important (should fix)

[WARN] file:line - Issue
  -> Fix

## Minor

[NIT] file:line - Issue
  -> Fix

## Strengths

- What's done well

## Verdict

LGTM / LGTM with nits / Needs work
```

## Quick Review (small changes)

For < 50 lines, use this checklist:

- [ ] Logic correct, edge cases handled
- [ ] Errors handled, not swallowed
- [ ] No security issues
- [ ] No debug statements
- [ ] Naming clear
- [ ] Fits existing patterns
"""
description = "Deep code review - checks quality, style, security, performance"
